<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RF SMART Dashboard</title>
  <link rel="stylesheet" href="css/home.css">
  <script src="js/sidebar.js" defer></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f5f6fa;
    }
    .new-productcontainer {
      width: 85%;
      max-width: 900px;
      background-color: #fff;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      margin-top: 5%;
      margin-left: 8%;
      transition: all 0.3s ease;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .progress {
      background: #e8f5e9;
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      font-size: 14px;
      color: #2e7d32;
    }
    .form-group {
      margin-bottom: 25px;
      position: relative;
    }
    .form-group label {
      display: block;
      font-size: 15px;
      color: #2c3e50;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      font-size: 14px;
      color: #34495e;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s ease;
      background-color: #fff;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: #009688;
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 150, 136, 0.1);
    }
    .file-input-container {
      position: relative;
      padding: 20px;
      border: 2px dashed #009688;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .file-input-container:hover {
      background-color: #e8f5e9;
    }
    .file-input-container i {
      font-size: 24px;
      color: #009688;
      margin-bottom: 10px;
    }
    .btn {
      display: inline-block;
      padding: 12px 25px;
      font-size: 15px;
      font-weight: 500;
      color: #fff;
      background-color: #009688;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .btn:hover {
      background-color: #00796b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .loading {
      position: relative;
      pointer-events: none;
      opacity: 0.8;
    }
    .loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: loading 0.8s linear infinite;
    }
    @keyframes loading {
      to {
        transform: rotate(360deg);
      }
    }
    @media (max-width: 600px) {
      .new-productcontainer {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo-details">
      <div class="logo_name">RFSmart <img src="img/logo.svg" alt=""></div>
      <i class='bx bx-menu' id="btn"></i>
    </div>
    <ul class="nav-list">
      <li>
        <i class='bx bx-search'></i>
        <input type="text" placeholder="Search...">
        <span class="tooltip">Search</span>
      </li>
      <li>
        <a href="home.html">
          <i class='bx bx-grid-alt'></i>
          <span class="links_name">Dashboard</span>
        </a>
        <span class="tooltip">Dashboard</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-user'></i>
          <span class="links_name">User</span>
        </a>
        <span class="tooltip">User</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-box'></i>
          <span class="links_name">Produtos</span>
        </a>
        <span class="tooltip">Produtos</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-pie-chart-alt-2'></i>
          <span class="links_name">Analytics</span>
        </a>
        <span class="tooltip">Analytics</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-folder'></i>
          <span class="links_name">Files</span>
        </a>
        <span class="tooltip">Files</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-cart-alt'></i>
          <span class="links_name">Order</span>
        </a>
        <span class="tooltip">Order</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-heart'></i>
          <span class="links_name">Saved</span>
        </a>
        <span class="tooltip">Saved</span>
      </li>
      <li>
        <a href="">
          <i class='bx bx-cog'></i>
          <span class="links_name">Settings</span>
        </a>
        <span class="tooltip">Settings</span>
      </li>
      <li class="profile">
        <div class="profile-details">
          <div class="name_job">
            <div class="name">User</div>
            <div class="job">Vendedor</div>
          </div>
        </div>
        <i class='bx bx-log-out' id="log_out" onclick="exit()"></i>
      </li>
    </ul>
  </div>
  <section class="home-section">
    <div class="dashboard">
      <div class="new-productcontainer">
        <div class="header">
          <h1>Ol√°, <span id="userName">User</span> <span>üíö</span></h1>
          <div class="progress">
            <span>Starter</span>
            <span>Pr√≥xima conquista: R$ 10k</span>
          </div>
        </div>
        <hr style="margin-bottom: 5%;">
        <h1>Vamos criar seu produto na RFSmart</h1>
        <p>Conte sobre seu produto. Estas informa√ß√µes estar√£o vis√≠veis para todos.</p>
        <div class="form-group">
          <label for="product-name">Nome do seu produto</label>
          <input type="text" id="product-name" placeholder="Ex: Iniciantes no Marketing Digital" required>
        </div>
        <div class="form-group">
          <label for="category">Categoria</label>
          <select id="category" required>
            <option value="">Selecione um nicho</option>
            <option>Marketing Digital</option>
            <option>Finan√ßas</option>
            <option>Desenvolvimento Pessoal</option>
            <option>Relacionamentos</option>
            <option>Produtividade</option>
            <option>Outros</option>
          </select>
        </div>
        <div class="form-group">
          <label for="product-description">Descri√ß√£o</label>
          <textarea id="product-description" placeholder="Conte mais sobre seu produto" rows="10" style="width: 100%;" required></textarea>
        </div>
        <div class="form-group">
          <label for="product-image">Imagem do Produto</label>
          <div class="file-input-container" id="image-drop-zone">
            <i class='bx bx-image-add'></i>
            <p>Arraste uma imagem ou clique para selecionar</p>
            <input type="file" id="product-image" accept="image/*" style="display: none;">
            <div id="image-preview"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="product-video">V√≠deo do Produto</label>
          <input type="file" id="product-video" accept="video/*">
        </div>
        <div class="form-group">
          <label for="product-pdf">Arquivo PDF</label>
          <input type="file" id="product-pdf" accept="application/pdf">
        </div>
        <div class="form-group">
          <label for="whatsapp">Link para contato no WhatsApp</label>
          <input 
            type="url" 
            id="whatsapp" 
            placeholder="Ex: https://wa.me/5511999999999" 
            required
          >
          <small>Insira o link completo para iniciar uma conversa no WhatsApp.</small>
        </div>
        <button class="btn" id="submit-product">CONTINUAR</button>
      </div>
    </div>
  </section>

  <script>
    // Carrega dados do usu√°rio
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");
      if (!token) {
        alert("Voc√™ precisa estar logado!");
        window.location.href = "/index.html";
        return;
      }
      try {
        const response = await fetch("https://rfsmart-back-end.onrender.com/me", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
        if (!response.ok) throw new Error("Erro ao buscar dados do usu√°rio");
        const data = await response.json();
        document.getElementById("userName").textContent = data.name;
        // Atualiza tamb√©m o sidebar se necess√°rio
        const sidebarName = document.querySelector(".name");
        if (sidebarName) sidebarName.textContent = data.name;
      } catch (error) {
        console.error("Erro:", error);
        alert("Erro ao carregar dados do usu√°rio.");
      }
    });

    // Fun√ß√£o para sair
    function exit() {
      localStorage.removeItem("token");
      window.location.href = "/index.html";
    }

    // Fun√ß√£o para salvar arquivos (simula√ß√£o: armazenamento local)
    function saveFileToLocalStorage(inputElement, productId, fileType) {
      const file = inputElement.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          localStorage.setItem(`${productId}_${fileType}`, e.target.result);
        };
        reader.readAsDataURL(file);
      }
    }

    // Adiciona preview de imagem e drag and drop
    const imageDropZone = document.getElementById('image-drop-zone');
    const imageInput = document.getElementById('product-image');
    const imagePreview = document.getElementById('image-preview');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageDropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        imageDropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        imageDropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        imageDropZone.classList.add('highlight');
    }

    function unhighlight(e) {
        imageDropZone.classList.remove('highlight');
    }

    imageDropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        if (files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 200px; margin-top: 10px;">`;
            }
            reader.readAsDataURL(files[0]);
        }
    }

    imageDropZone.addEventListener('click', () => imageInput.click());
    
    imageInput.addEventListener('change', function() {
        handleFiles(this.files);
    });

    // Fun√ß√£o para enviar o cadastro de produto utilizando async/await
    document.getElementById('submit-product').addEventListener('click', async (e) => {
      const button = e.target;
      button.classList.add('loading');
      button.textContent = 'Processando...';
      
      const productName = document.getElementById('product-name').value.trim();
      const category = document.getElementById('category').value;
      const description = document.getElementById('product-description').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim();

      if (!productName || !category || !description) {
        alert("Preencha todos os campos obrigat√≥rios!");
        button.classList.remove('loading');
        button.textContent = 'CONTINUAR';
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Voc√™ precisa estar logado!");
        window.location.href = "/login.html";
        button.classList.remove('loading');
        button.textContent = 'CONTINUAR';
        return;
      }

      try {
        const response = await fetch("https://rfsmart-back-end.onrender.com/produtos", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            name: productName,
            category: category,
            description: description,
            whatsapp: whatsapp
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Erro ao cadastrar produto");
        }

        const data = await response.json();
        const productId = data.product.id;

        // Armazenamento local dos arquivos (opcional)
        saveFileToLocalStorage(document.getElementById('product-image'), productId, 'image');
        saveFileToLocalStorage(document.getElementById('product-video'), productId, 'video');
        saveFileToLocalStorage(document.getElementById('product-pdf'), productId, 'pdf');

        alert("Produto cadastrado com sucesso!");
        window.location.href = "/products.html";
      } catch (error) {
        console.error("Erro:", error);
        alert(error.message);
      } finally {
        button.classList.remove('loading');
        button.textContent = 'CONTINUAR';
      }
    });
  </script>
</body>
</html>
